<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ApprovalHistory">
    <!-- 문서에 관한 결재기록 조회 -->
    <select id="getListByApprovalId" resultType="com.kedu.ggirick_client_backend.dto.approval.ApprovalHistoryDTO">
        SELECT * FROM approval_history WHERE approval_id=#{approvalId} ORDER BY recorded_at DESC
    </select>

    <!-- assigner와 approvalId를 가지는 결재기록 조회 -->
    <select id="getByAssignerAndApprovalId"
            resultType="com.kedu.ggirick_client_backend.dto.approval.ApprovalHistoryDTO">
        SELECT * FROM approval_history
        WHERE approval_id=#{approvalId} AND
        assigner=#{userId} AND
        recorded_at between
        (SELECT updated_at FROM approval WHERE id=#{approvalId})
        AND
        sysdate
        ORDER BY recorded_at DESC
    </select>

    <!-- 이전 결재자의 결재기록 조회 -->
    <select id="getPrevHistory" resultType="com.kedu.ggirick_client_backend.dto.approval.ApprovalHistoryDTO">
        SELECT *
        FROM approval_history ah
        WHERE ah.assigner = (
            SELECT al.assigner
            FROM approval_line al
            WHERE al.order_line = #{userOrderLine} - 1
            AND al.approval_id = #{approvalId}
        )
        AND ah.approval_id = #{approvalId}
        ORDER BY recorded_at DESC
    </select>

    <!-- 결재 변경이력 기록 -->
    <insert id="insert">
        INSERT INTO approval_history(id, approval_id, assigner, contents, type_id, recorded_at, is_delegated)
        VALUES(approval_history_seq.nextval, #{approvalId}, #{assigner}, #{contents}, #{typeId}, sysdate,
        #{isDelegated})
    </insert>

    <!-- 결재 기록 취소(삭제) -->
    <delete id="deleteByApprovalIdAndAssigner">
        DELETE FROM approval_history WHERE approval_id=#{approvalId} AND assigner=#{userId}
    </delete>
</mapper>